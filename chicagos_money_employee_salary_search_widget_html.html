<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chicago Employee Salaries ‚Äî Search</title>
  <style>
    :root {
      --bg:#0b0c10; --card:#111218; --muted:#1a1b22; --text:#e8e9ee; --sub:#a9adbf; --accent:#ffd166; --line:#242632;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"}
    .wrap{max-width:1100px;margin:48px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{font-size:28px;margin:0 0 16px}
    p.lead{color:var(--sub);margin:0 0 24px}
    form{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;padding:18px;border-bottom:1px solid var(--line)}
    label{font-size:12px;color:var(--sub);display:block;margin-bottom:6px}
    input,select,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--muted);color:var(--text)}
    input::placeholder{color:#7b8092}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-9{grid-column:span 9}
    .col-12{grid-column:span 12}
    .controls{display:flex;gap:12px;align-items:end}
    .btn{cursor:pointer;background:#222432;border:1px solid #2b2d3a}
    .btn.primary{background:linear-gradient(180deg,#2c2f3b,#20222d);border-color:#2b2e3a}
    .btn.accent{background:var(--accent);color:#1a1a1a;border-color:#e0b34a}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .results{padding:8px 18px 18px}
    .meta{display:flex;gap:12px;align-items:center;justify-content:space-between;margin:12px 0}
    .meta small{color:var(--sub)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:clip;border-radius:12px;border:1px solid var(--line)}
    thead th{font-size:12px;color:var(--sub);text-align:left;background:#0f1016;padding:10px 12px;border-bottom:1px solid var(--line)}
    tbody td{padding:12px;border-bottom:1px solid var(--line)}
    tbody tr:hover{background:#141621}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line);background:#171926;color:var(--sub)}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:#141621}
    .hl{background:linear-gradient(90deg,rgba(255,209,102,.2),rgba(255,209,102,.05));border:1px solid rgba(255,209,102,.35)}
    .notice{margin-top:10px;color:var(--sub)}
    .skeleton{height:12px;background:#1b1d27;border-radius:6px;animation:pulse 1.2s infinite ease-in-out}
    @keyframes pulse{0%{opacity:.5}50%{opacity:1}100%{opacity:.5}}
    @media (max-width:900px){.col-3,.col-4,.col-6,.col-8,.col-9{grid-column:span 12}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="padding:18px 18px 0">
        <h1>Search City of Chicago Employee Salaries</h1>
        <p class="lead">Live query of the City of Chicago <em>Current Employee Names, Salaries, and Position Titles</em> dataset via Socrata. Filter by name, department, job title, and pay. Data is fetched directly from the portal on every search.</p>
      </div>

      <form id="searchForm">
        <div class="col-4">
          <label for="name">Name (contains)</label>
          <input id="name" name="name" type="text" placeholder="e.g., SMITH" />
        </div>
        <div class="col-4">
          <label for="dept">Department</label>
          <select id="dept" name="dept">
            <option value="">All departments‚Ä¶</option>
          </select>
        </div>
        <div class="col-4">
          <label for="title">Job Title (contains)</label>
          <input id="title" name="title" type="text" placeholder="e.g., ENGINEER" />
        </div>
        <div class="col-3">
          <label for="minSal">Min Annual Salary ($)</label>
          <input id="minSal" name="minSal" type="number" inputmode="numeric" min="0" step="1000" placeholder="50000" />
        </div>
        <div class="col-3">
          <label for="maxSal">Max Annual Salary ($)</label>
          <input id="maxSal" name="maxSal" type="number" inputmode="numeric" min="0" step="1000" placeholder="200000" />
        </div>
        <div class="col-3">
          <label for="ft">Status</label>
          <select id="ft" name="ft">
            <option value="">All</option>
            <option value="F">Full-time</option>
            <option value="P">Part-time</option>
          </select>
        </div>
        <div class="col-3">
          <label for="payType">Pay Type</label>
          <select id="payType" name="payType">
            <option value="">Salary + Hourly</option>
            <option value="Salary">Salary only</option>
            <option value="Hourly">Hourly only</option>
          </select>
        </div>
        <div class="col-9 controls">
          <div style="flex:1">
            <label for="sortBy">Sort</label>
            <select id="sortBy">
              <option value="employee_annual_salary DESC">Annual Salary ‚Üì</option>
              <option value="employee_annual_salary ASC">Annual Salary ‚Üë</option>
              <option value="name ASC">Name A‚ÜíZ</option>
              <option value="department ASC">Department A‚ÜíZ</option>
            </select>
          </div>
          <div>
            <label for="limit">Per page</label>
            <select id="limit">
              <option>25</option>
              <option selected>50</option>
              <option>100</option>
            </select>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn accent" type="submit">Search</button>
            <button class="btn" type="button" id="resetBtn">Reset</button>
          </div>
        </div>
        <div class="col-3">
          <label>Quick Links</label>
          <div class="pill hl" id="exportCsv" style="justify-content:space-between;cursor:pointer" title="Download current results as CSV">üì• Export CSV</div>
        </div>
      </form>

      <div class="results" id="results">
        <div class="meta">
          <small id="resultCount">Use the search to load results.</small>
          <div style="display:flex; gap:6px">
            <button class="btn" id="prevBtn" disabled>‚Üê Prev</button>
            <button class="btn" id="nextBtn" disabled>Next ‚Üí</button>
          </div>
        </div>
        <div style="overflow:auto">
          <table id="table" hidden>
            <thead>
              <tr>
                <th style="min-width:220px">Name</th>
                <th style="min-width:200px">Job Title</th>
                <th>Department</th>
                <th>Pay Type</th>
                <th class="num">Annual Salary</th>
                <th class="num">Hourly Rate</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="notice">
          <small>Data source: City of Chicago ‚Äî ‚ÄúCurrent Employee Names, Salaries, and Position Titles‚Äù (resource <code>xzkq-xp2w</code>). Updated by the City; we query it live.</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======== CONFIG ========
    const DATASET = "xzkq-xp2w"; // Current Employee Names, Salaries, and Position Titles
    const BASE = `https://data.cityofchicago.org/resource/${DATASET}.json`;
    const CSV =  `https://data.cityofchicago.org/resource/${DATASET}.csv`;
    const APP_TOKEN = "YOUR_APP_TOKEN_HERE"; // Get one (free) from the Chicago Data Portal / Socrata

    // ======== UTIL ========
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => [...root.querySelectorAll(sel)];
    const escapeSoql = (s) => String(s).replaceAll("'", "''"); // double single-quotes per SoQL
    const fmt = new Intl.NumberFormat(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});

    function buildWhere(params){
      const where = [];
      if(params.name){
        const v = escapeSoql(params.name.trim());
        where.push(`upper(name) like upper('%${v}%')`);
      }
      if(params.dept){
        const v = escapeSoql(params.dept);
        where.push(`department='${v}'`);
      }
      if(params.title){
        const v = escapeSoql(params.title.trim());
        where.push(`upper(job_titles) like upper('%${v}%')`);
      }
      if(params.payType){
        where.push(`salary_or_hourly='${params.payType}'`);
      }
      if(params.ft){
        where.push(`full_or_part_time='${params.ft}'`);
      }
      const min = Number(params.minSal||'');
      const max = Number(params.maxSal||'');
      if(!Number.isNaN(min) && min>0){
        where.push(`employee_annual_salary >= ${min}`);
      }
      if(!Number.isNaN(max) && max>0){
        where.push(`employee_annual_salary <= ${max}`);
      }
      return where.join(' AND ');
    }

    function paramsFromForm(){
      return {
        name: $('#name').value,
        dept: $('#dept').value,
        title: $('#title').value,
        minSal: $('#minSal').value,
        maxSal: $('#maxSal').value,
        ft: $('#ft').value,
        payType: $('#payType').value,
        sortBy: $('#sortBy').value,
        limit: Number($('#limit').value)
      };
    }

    let pageOffset = 0; // for pagination
    let lastParams = null; // for CSV export

    async function fetchJSON(url){
      const headers = APP_TOKEN && APP_TOKEN !== 'YOUR_APP_TOKEN_HERE' ? { 'X-App-Token': APP_TOKEN } : {};
      const res = await fetch(url, { headers });
      if(!res.ok){
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return res.json();
    }

    async function fetchCount(where){
      const u = new URL(BASE);
      u.searchParams.set('$select', 'count(1) as c');
      if(where) u.searchParams.set('$where', where);
      return fetchJSON(u).then(r => (r?.[0]?.c ? Number(r[0].c) : 0));
    }

    async function fetchPage(where, order, limit, offset){
      const u = new URL(BASE);
      u.searchParams.set('$select', [
        'name','job_titles','department','salary_or_hourly','employee_annual_salary','hourly_rate','full_or_part_time'
      ].join(','));
      if(where) u.searchParams.set('$where', where);
      if(order) u.searchParams.set('$order', order);
      u.searchParams.set('$limit', String(limit));
      u.searchParams.set('$offset', String(offset));
      return fetchJSON(u);
    }

    function renderRows(rows){
      const tbody = $('#table tbody');
      tbody.innerHTML = '';
      for(const r of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${r.name || ''}</strong><br><span class="badge">${r.full_or_part_time==='F' ? 'Full-time' : r.full_or_part_time==='P' ? 'Part-time' : (r.full_or_part_time||'')}</span></td>
          <td>${r.job_titles || ''}</td>
          <td>${r.department || ''}</td>
          <td>${r.salary_or_hourly || ''}</td>
          <td class="num">${r.employee_annual_salary ? fmt.format(Number(r.employee_annual_salary)) : ''}</td>
          <td class="num">${r.hourly_rate ? fmt.format(Number(r.hourly_rate)) : ''}</td>
        `;
        tbody.appendChild(tr);
      }
      $('#table').hidden = rows.length === 0;
    }

    function setPager(total, limit){
      const start = total === 0 ? 0 : pageOffset + 1;
      const end = Math.min(pageOffset + limit, total);
      $('#resultCount').textContent = total ? `Showing ${start}‚Äì${end} of ${total} employees` : 'No results.';
      $('#prevBtn').disabled = pageOffset === 0;
      $('#nextBtn').disabled = pageOffset + limit >= total;
    }

    function updateCsvLink(where){
      const u = new URL(CSV);
      u.searchParams.set('$select','name,job_titles,department,salary_or_hourly,employee_annual_salary,hourly_rate,full_or_part_time');
      if(where) u.searchParams.set('$where', where);
      u.searchParams.set('$order', ($('#sortBy').value));
      u.searchParams.set('$limit','50000'); // export up to 50k rows
      if(APP_TOKEN && APP_TOKEN !== 'YOUR_APP_TOKEN_HERE'){
        u.searchParams.set('$$app_token', APP_TOKEN); // query param works well for CSV downloads
      }
      const exportBtn = $('#exportCsv');
      exportBtn.onclick = () => window.open(u.toString(), '_blank');
    }

    async function runSearch(resetOffset=false){
      try{
        const params = paramsFromForm();
        if(resetOffset) pageOffset = 0;
        lastParams = params;
        const where = buildWhere(params);
        $('#resultCount').innerHTML = '<span class="skeleton" style="display:inline-block;width:220px"></span>';
        updateCsvLink(where);
        const [total, rows] = await Promise.all([
          fetchCount(where),
          fetchPage(where, params.sortBy, params.limit, pageOffset)
        ]);
        renderRows(rows);
        setPager(total, params.limit);
      }catch(err){
        console.error(err);
        $('#resultCount').textContent = 'Error loading data. Try again in a moment.';
      }
    }

    // Pagination
    $('#prevBtn').addEventListener('click', () => { const {limit} = paramsFromForm(); pageOffset = Math.max(0, pageOffset - limit); runSearch(false); });
    $('#nextBtn').addEventListener('click', () => { const {limit} = paramsFromForm(); pageOffset += limit; runSearch(false); });

    // Form submit / reset
    $('#searchForm').addEventListener('submit', (e) => { e.preventDefault(); runSearch(true); });
    $('#resetBtn').addEventListener('click', () => { $('#searchForm').reset(); pageOffset=0; $('#dept').value=''; $('#payType').value=''; $('#ft').value=''; runSearch(true); });

    // Populate department dropdown (distinct departments)
    async function loadDepartments(){
      try{
        const u = new URL(BASE);
        u.searchParams.set('$select', 'department');
        u.searchParams.set('$group', 'department');
        u.searchParams.set('$order', 'department');
        const rows = await fetchJSON(u);
        const sel = $('#dept');
        for(const r of rows){
          if(!r.department) continue;
          const opt = document.createElement('option');
          opt.value = r.department; opt.textContent = r.department;
          sel.appendChild(opt);
        }
      }catch(e){ console.warn('Dept load failed', e); }
    }

    // Init
    loadDepartments();
    // Optional: kick a default search for top earners
    (function showTopEarners(){
      $('#minSal').value = '200000';
      runSearch(true);
    })();
  </script>
</body>
</html>
