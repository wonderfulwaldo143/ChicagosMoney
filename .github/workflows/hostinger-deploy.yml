name: Deploy to Hostinger

on:
  push:
    branches: [main]
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - '**/*.json'
      - '**/*.xml'
      - '**/*.txt'
      - '**/*.php'
      - '**/.htaccess'
      - '.htaccess'
      - 'IMG/**'
      - 'icons/**'
      - 'api/**'
      - 'assets/**'
      - 'sw.js'
      - 'manifest.json'
      - 'sitemap.xml'
      - 'robots.txt'
      - 'version.txt'
      - '.github/workflows/hostinger-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy via SFTP
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: cm-deploy-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp

      - name: Generate version file
        run: |
          echo "${{ github.sha }} $(date -u +'%Y-%m-%dT%H:%M:%SZ')" > version.txt
          echo "üìù Generated version.txt: $(cat version.txt)"

      - name: Deploy to Hostinger
        env:
          HOST: ${{ secrets.HOSTINGER_FTP_SERVER }}
          PORT: ${{ secrets.HOSTINGER_FTP_PORT }}
          USER: ${{ secrets.HOSTINGER_FTP_USERNAME }}
          PASS: ${{ secrets.HOSTINGER_FTP_PASSWORD }}
          REMOTE_DIR: ${{ secrets.HOSTINGER_REMOTE_DIR }}
        run: |
          set +e
          echo "üöÄ Starting deployment..."
          echo "üìã Connection details:"
          echo "   Host: $HOST"
          echo "   Port: $PORT"
          echo "   User: $USER"
          echo "   Remote Dir: $REMOTE_DIR"

          lftp -u "$USER","$PASS" sftp://"$HOST":"$PORT" <<'EOF'
          set net:timeout 30
          set net:max-retries 3
          set net:reconnect-interval-base 5
          set sftp:auto-confirm yes
          set xfer:clobber on

          cd /home/u476428393/public_html
          lcd $GITHUB_WORKSPACE

          mirror -R \
            --parallel=4 \
            --continue \
            --only-newer \
            --verbose \
            --exclude-glob .git* \
            --exclude-glob .github/ \
            --exclude-glob node_modules/ \
            --exclude-glob '*.map' \
            --exclude-glob '*.md' \
            --exclude-glob deploy.sh \
            --exclude-glob .DS_Store \
            --exclude-glob .deploy-trigger \
            --exclude-glob docs/ \
            --exclude-glob backups/ \
            --exclude-glob logs/

          bye
          EOF

          STATUS=$?
          # lftp exit 1 is commonly benign (e.g., trying to remove non-existent file).
          if [ $STATUS -ne 0 ] && [ $STATUS -ne 1 ]; then
            echo "::error::lftp failed with exit code $STATUS"
            exit $STATUS
          fi
          echo "‚úÖ Deployment complete (exit=$STATUS)"

      - name: Verify live site updated
        run: |
          echo "‚è≥ Waiting 10 seconds for file propagation..."
          sleep 10

          echo "üîç Verifying homepage is accessible..."
          if curl -sS -f -o /dev/null "https://chicagosmoney.com/?cb=${{ github.run_id }}"; then
            echo "‚úÖ Homepage is accessible"
          else
            echo "‚ùå Homepage check failed"
            exit 1
          fi

          echo ""
          echo "üîç Checking if version.txt is accessible..."
          URL="https://chicagosmoney.com/version.txt?cb=${{ github.run_id }}"

          HTTP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/live_version.txt "$URL")
          echo "üìä HTTP Status: $HTTP_CODE"

          # Check if we got actual version.txt content (not HTML)
          if [ "$HTTP_CODE" = "200" ] && grep -q "^[0-9a-f]\{40\}" /tmp/live_version.txt 2>/dev/null; then
            echo "‚úÖ version.txt accessible and valid"
            echo "üìÑ Content: $(cat /tmp/live_version.txt)"

            if grep -q "${{ github.sha }}" /tmp/live_version.txt; then
              echo "‚úÖ Live version matches this build: ${{ github.sha }}"
            else
              echo "‚ö†Ô∏è  Version mismatch (may indicate caching or race condition)"
              echo "   Expected: ${{ github.sha }}"
              echo "   Got: $(cat /tmp/live_version.txt)"
            fi
          else
            echo "‚ö†Ô∏è  version.txt not accessible or returned HTML (common on .htaccess 404 redirect)"
            if [ -f /tmp/live_version.txt ]; then
              echo "üìÑ First 150 chars of response:"
              head -c 150 /tmp/live_version.txt | tr '\n' ' '
              echo ""
            fi
            echo "‚ÑπÔ∏è  This is expected if ErrorDocument 404 redirects to index.html"
          fi

          echo ""
          echo "‚úÖ Deployment verification complete - site is live!"
