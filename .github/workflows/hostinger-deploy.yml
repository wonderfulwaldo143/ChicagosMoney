name: Deploy to Hostinger

on:
  push:
    branches: [main]
    paths:
      - '**/*.html'
      - '**/*.css'
      - '**/*.js'
      - '**/*.json'
      - '**/*.xml'
      - '**/*.txt'
      - '**/*.php'
      - 'deploy-info.php'
      - '**/.htaccess'
      - '.htaccess'
      - 'IMG/**'
      - 'icons/**'
      - 'api/**'
      - 'assets/**'
      - 'sw.js'
      - 'manifest.json'
      - 'sitemap.xml'
      - 'robots.txt'
      - 'version.txt'
      - '.github/workflows/hostinger-deploy.yml'
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy via SSH rsync
    runs-on: ubuntu-latest
    timeout-minutes: 20
    concurrency:
      group: cm-deploy-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate version file and add cache busting
        run: |
          VERSION="${{ github.sha }}"
          TIMESTAMP="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          # Update version.txt in public_html
          echo "$VERSION $TIMESTAMP" > public_html/version.txt
          echo "üìù Generated version.txt: $(cat public_html/version.txt)"

          # Add version comments to CSS and JS files for cache verification
          COMMENT="/* Deployed: $VERSION at $TIMESTAMP */"

          # Add comment to CSS (if exists and not already present)
          if [ -f public_html/styles.css ] && ! head -1 public_html/styles.css | grep -q "Deployed:"; then
            { echo "$COMMENT"; cat public_html/styles.css; } > public_html/styles.css.tmp && mv public_html/styles.css.tmp public_html/styles.css
            echo "‚úÖ Added version stamp to styles.css"
          fi

          # Add comment to JS (if exists and not already present)
          if [ -f public_html/script.js ] && ! head -1 public_html/script.js | grep -q "Deployed:"; then
            { echo "$COMMENT"; cat public_html/script.js; } > public_html/script.js.tmp && mv public_html/script.js.tmp public_html/script.js
            echo "‚úÖ Added version stamp to script.js"
          fi

          # Create a timestamp file to verify uploads
          echo "Deployed: $VERSION at $TIMESTAMP" > public_html/.last-deploy
          echo "üìù Created .last-deploy marker"

      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.HOSTINGER_SSH_KEY }}
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: Add Hostinger host key
        env:
          HOST: ${{ secrets.HOSTINGER_HOST }}
          PORT: ${{ secrets.HOSTINGER_SSH_PORT }}
        run: |
          ssh-keyscan -p "$PORT" "$HOST" >> ~/.ssh/known_hosts

      - name: Deploy to Hostinger via rsync
        env:
          HOST: ${{ secrets.HOSTINGER_HOST }}
          PORT: ${{ secrets.HOSTINGER_SSH_PORT }}
          USER: ${{ secrets.HOSTINGER_USER }}
          REMOTE_DIR: ${{ secrets.HOSTINGER_PATH }}
        run: |
          RSYNC_SSH="ssh -i ~/.ssh/id_ed25519 -p $PORT -o StrictHostKeyChecking=yes"
          echo "üöÄ Starting rsync deployment to $USER@$HOST:$REMOTE_DIR"

          rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='.gitattributes' \
            --exclude='.vscode' \
            --exclude='.DS_Store' \
            --exclude='node_modules' \
            --exclude='backups' \
            --exclude='docs' \
            --exclude='*.log' \
            --exclude='*.tmp' \
            -e "$RSYNC_SSH" \
            public_html/ \
            "$USER@$HOST:$REMOTE_DIR/"

      - name: Verify live site updated
        run: |
          echo "‚è≥ Waiting 15 seconds for file propagation and CDN..."
          sleep 15

          EXPECTED_SHA="${{ github.sha }}"
          MAX_ATTEMPTS=3
          ATTEMPT=1

          echo "üîç Verifying homepage is accessible..."
          if curl -sS -f -o /dev/null "https://chicagosmoney.com/?cb=${{ github.run_id }}"; then
            echo "‚úÖ Homepage is accessible"
          else
            echo "‚ùå Homepage check failed"
            exit 1
          fi

          echo ""
          echo "üîç Checking CSS file for version stamp..."
          curl -sS "https://chicagosmoney.com/styles.css?cb=${{ github.run_id }}" | head -3

          if curl -sS "https://chicagosmoney.com/styles.css?cb=${{ github.run_id }}" | head -1 | grep -q "$EXPECTED_SHA"; then
            echo "‚úÖ CSS contains current version stamp"
          else
            echo "‚ö†Ô∏è  CSS may be cached (old version)"
          fi

          echo ""
          echo "üîç Attempting to verify version.txt (up to $MAX_ATTEMPTS tries)..."

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "üîÑ Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            URL="https://chicagosmoney.com/version.txt?cb=${{ github.run_id }}_${ATTEMPT}"
            HTTP_CODE=$(curl -sS -w "%{http_code}" -o /tmp/live_version.txt "$URL")

            # Check if we got actual version.txt content (not HTML)
            if [ "$HTTP_CODE" = "200" ] && grep -q "^[0-9a-f]\{40\}" /tmp/live_version.txt 2>/dev/null; then
              echo "‚úÖ version.txt accessible and valid"
              echo "üìÑ Content: $(cat /tmp/live_version.txt)"

              if grep -q "$EXPECTED_SHA" /tmp/live_version.txt; then
                echo "‚úÖ Live version matches this build!"
                break
              else
                echo "‚ö†Ô∏è  Version mismatch - may be cached"
                echo "   Expected: $EXPECTED_SHA"
                echo "   Got: $(cat /tmp/live_version.txt)"
              fi
            else
              echo "‚ö†Ô∏è  HTTP $HTTP_CODE - version.txt returned HTML or is inaccessible"
              if [ -f /tmp/live_version.txt ]; then
                echo "üìÑ First 100 chars:"
                head -c 100 /tmp/live_version.txt | tr '\n' ' '
                echo ""
              fi
            fi

            ATTEMPT=$((ATTEMPT + 1))
            if [ $ATTEMPT -le $MAX_ATTEMPTS ]; then
              echo "‚è≥ Waiting 10 seconds before retry..."
              sleep 10
            fi
          done

          echo ""
          echo "‚ÑπÔ∏è  If version.txt shows old version, clear CDN cache at Hostinger control panel"
          echo "‚úÖ Deployment verification complete - files uploaded successfully!"
