<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chicago's Money â€” Civic Budget Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=DM+Sans:wght@500;700&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="/IMG/chicagos_money_logo_variant_1.png" type="image/png" />
  <style>
    :root {
      --deep-bg: #05060f;
      --panel: rgba(14, 16, 31, 0.85);
      --panel-alt: rgba(19, 22, 40, 0.9);
      --accent-blue: #7cd0ff;
      --accent-green: #89f8d4;
      --accent-gold: #ffd166;
      --text-primary: rgba(230, 234, 255, 0.96);
      --text-secondary: rgba(184, 195, 236, 0.78);
      --border: rgba(90, 110, 170, 0.2);
    }

    body {
      margin: 0;
      background: radial-gradient(140% 120% at 5% 0%, rgba(129, 212, 250, 0.15), transparent 60%),
        radial-gradient(160% 140% at 95% 10%, rgba(255, 176, 0, 0.12), transparent 65%),
        var(--deep-bg);
      color: var(--text-primary);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .toast {
      position: fixed;
      bottom: 28px;
      right: 32px;
      background: rgba(14, 17, 32, 0.92);
      border: 1px solid rgba(124, 208, 255, 0.24);
      color: rgba(224, 230, 255, 0.94);
      padding: 0.75rem 1.2rem;
      border-radius: 999px;
      font-size: 0.9rem;
      letter-spacing: 0.03em;
      box-shadow: 0 18px 35px -24px rgba(0, 0, 0, 0.65);
      opacity: 0;
      transform: translateY(16px);
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 250;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    .navbar {
      background: rgba(8, 10, 22, 0.65);
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(112, 136, 225, 0.15);
      position: sticky;
      top: 0;
      z-index: 100;
      padding: 1rem 0;
    }

    .nav-container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      position: relative;
    }

    .logo {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 800;
      font-size: 1.45rem;
      letter-spacing: 0.01em;
      text-decoration: none;
      color: var(--text-primary);
    }

    .logo-chicago {
      color: rgba(124, 208, 255, 0.95);
    }

    .logo-dollar {
      color: var(--accent-gold);
      font-size: 1.75rem;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      transform: translateY(-1px);
    }

    .logo-money {
      color: var(--accent-green);
    }

    .nav-links {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .nav-link {
      color: rgba(218, 226, 255, 0.82);
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      letter-spacing: 0.01em;
      position: relative;
      transition: color 0.2s ease, transform 0.2s ease;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      left: 0;
      bottom: -6px;
      width: 0;
      height: 2px;
      background: var(--accent-gold);
      border-radius: 999px;
      transition: width 0.25s ease;
      opacity: 0.85;
    }

    .nav-link:hover,
    .nav-link:focus-visible {
      color: var(--accent-gold);
      transform: translateY(-1px);
    }

    .nav-link:hover::after,
    .nav-link:focus-visible::after,
    .nav-link.active::after {
      width: 100%;
    }

    .nav-link.active {
      color: var(--accent-gold);
    }

    .nav-cta {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.35rem;
      text-decoration: none;
      font-weight: 600;
      letter-spacing: 0.03em;
      padding: 0.55rem 1.25rem;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(124, 208, 255, 0.35), rgba(137, 248, 212, 0.42));
      color: rgba(9, 12, 24, 0.92);
      border: 1px solid rgba(124, 208, 255, 0.3);
      box-shadow: 0 18px 35px -22px rgba(46, 210, 255, 0.5);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .nav-cta:hover,
    .nav-cta:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 22px 40px -20px rgba(46, 210, 255, 0.55);
    }

    .mobile-menu-btn {
      display: none;
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: 1px solid rgba(124, 208, 255, 0.3);
      background: rgba(26, 32, 58, 0.6);
      color: rgba(218, 226, 255, 0.9);
      align-items: center;
      justify-content: center;
      gap: 5px;
      cursor: pointer;
      transition: border-color 0.2s ease, background 0.2s ease;
      margin-left: auto;
    }

    .mobile-menu-btn:hover,
    .mobile-menu-btn:focus-visible {
      border-color: rgba(255, 209, 102, 0.45);
      background: rgba(32, 40, 68, 0.8);
    }

    .mobile-menu-btn span {
      display: block;
      width: 20px;
      height: 2px;
      background: currentColor;
      border-radius: 999px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .mobile-menu-btn span + span {
      margin-top: 5px;
    }

    .mobile-menu-btn.is-open span:nth-child(1) {
      transform: translateY(7px) rotate(45deg);
    }

    .mobile-menu-btn.is-open span:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-btn.is-open span:nth-child(3) {
      transform: translateY(-7px) rotate(-45deg);
    }

    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 4.5rem 24px 6rem;
      position: relative;
      z-index: 1;
    }

    .dashboard-hero {
      display: grid;
      gap: 2.5rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      margin-bottom: 3.5rem;
    }

    .summary-card {
      background: linear-gradient(135deg, rgba(33, 38, 68, 0.92), rgba(18, 20, 40, 0.88));
      border: 1px solid rgba(118, 144, 255, 0.18);
      border-radius: 20px;
      padding: 1.75rem;
      box-shadow: 0 25px 45px -30px rgba(0, 0, 0, 0.7);
      position: relative;
      overflow: hidden;
    }

    .summary-card::after {
      content: '';
      position: absolute;
      inset: auto -40% -40% -40%;
      height: 120%;
      background: radial-gradient(circle at top, rgba(135, 208, 255, 0.22), transparent 70%);
      transform: rotate(10deg);
      pointer-events: none;
    }

    .summary-label {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 0.75rem;
      color: rgba(137, 248, 212, 0.8);
      margin-bottom: 0.75rem;
    }

    .summary-value {
      font-size: clamp(2.2rem, 4vw, 2.8rem);
      font-weight: 800;
      font-family: 'DM Sans', sans-serif;
    }

    .summary-sub {
      margin-top: 1rem;
      color: var(--text-secondary);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .summary-delta {
      font-weight: 600;
      min-width: 3.5rem;
      color: var(--text-secondary);
    }

    .summary-delta.delta-positive { color: #6be9b8; }
    .summary-delta.delta-negative { color: #ff9aa2; }

    .summary-note {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .panel-note {
      color: var(--text-secondary);
      font-size: 0.95rem;
      margin: 0;
      max-width: 420px;
    }

    .highlight-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
    }

    .highlight-card {
      background: linear-gradient(135deg, rgba(36, 44, 76, 0.9), rgba(20, 24, 44, 0.88));
      border: 1px solid rgba(118, 144, 255, 0.16);
      border-radius: 18px;
      padding: 1.5rem;
      box-shadow: 0 22px 40px -30px rgba(6, 10, 24, 0.85);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      min-height: 160px;
    }

    .highlight-card .label {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.72rem;
      color: rgba(137, 208, 255, 0.75);
    }

    .highlight-card .value {
      font-size: clamp(1.6rem, 3vw, 2.05rem);
      font-weight: 700;
      color: rgba(232, 235, 255, 0.96);
      font-family: 'DM Sans', sans-serif;
    }

    .highlight-card .meta {
      color: var(--text-secondary);
      font-size: 0.9rem;
      line-height: 1.4;
    }

    .canvas-panel {
      background: var(--panel);
      border-radius: 24px;
      padding: 2rem;
      border: 1px solid var(--border);
      box-shadow: 0 28px 50px -32px rgba(6, 10, 24, 0.85);
      margin-bottom: 3rem;
    }

    .panel-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .panel-header h2 {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0.55rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(124, 208, 255, 0.2);
      background: rgba(26, 32, 58, 0.65);
      color: var(--text-secondary);
      font-size: 0.85rem;
      white-space: nowrap;
      cursor: pointer;
      transition: transform 0.2s ease, border-color 0.2s ease;
    }

    .filter-chip:hover,
    .filter-chip.active {
      transform: translateY(-2px);
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }

    .insight-stack {
      display: grid;
      grid-template-columns: minmax(340px, 1.7fr) minmax(280px, 1fr);
      gap: 2rem;
      margin-bottom: 3rem;
      align-items: stretch;
    }

    .insight-intro {
      background: rgba(11, 14, 28, 0.92);
      border-radius: 22px;
      padding: 2rem;
      border: 1px solid rgba(118, 144, 255, 0.16);
      box-shadow: 0 25px 45px -32px rgba(6, 10, 24, 0.85);
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .insight-intro p {
      color: rgba(198, 206, 245, 0.78);
      margin: 0;
    }

    .insight-badges {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 1rem;
    }

    .insight-badge {
      background: linear-gradient(135deg, rgba(36, 44, 76, 0.95), rgba(30, 32, 54, 0.85));
      border-radius: 16px;
      padding: 1.1rem 1.2rem;
      border: 1px solid rgba(124, 208, 255, 0.16);
      box-shadow: 0 18px 35px -30px rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .insight-badge span:first-child {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      color: rgba(137, 248, 212, 0.85);
    }

    .insight-badge strong {
      font-size: 1.3rem;
      font-weight: 700;
      color: rgba(232, 235, 255, 0.95);
    }

    .insight-badge span:last-child {
      font-size: 0.85rem;
      color: rgba(184, 195, 236, 0.78);
    }

    .insight-table {
      background: rgba(11, 14, 28, 0.88);
      border-radius: 18px;
      padding: 1.25rem 1.5rem;
      border: 1px solid rgba(118, 144, 255, 0.14);
      box-shadow: 0 20px 45px -32px rgba(6, 10, 24, 0.85);
      overflow: hidden;
    }

    .insight-card {
      background: var(--panel-alt);
      border-radius: 20px;
      padding: 1.5rem;
      border: 1px solid rgba(118, 144, 255, 0.16);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      justify-content: space-between;
    }

    .insight-card.compact {
      min-height: auto;
    }

    .insight-table table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
    }

    .insight-table th,
    .insight-table td {
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid rgba(118, 144, 255, 0.1);
      color: rgba(224, 230, 255, 0.9);
      font-size: 0.92rem;
    }

    .insight-table th {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
      color: rgba(137, 208, 255, 0.7);
    }

    .insight-table td.metric {
      text-align: right;
      font-weight: 600;
    }

    .insight-card h3 {
      font-size: 1.1rem;
      margin: 0;
    }

    .insight-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 0.6rem;
    }

    .insight-list li {
      display: flex;
      justify-content: space-between;
      font-size: 0.95rem;
      color: rgba(198, 206, 245, 0.85);
    }

    .story-mode {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
    }

    .story-card {
      border-radius: 20px;
      padding: 1.8rem;
      border: 1px solid rgba(124, 208, 255, 0.18);
      background: radial-gradient(circle at -10% -10%, rgba(124, 208, 255, 0.16), transparent 55%),
        linear-gradient(155deg, rgba(20, 22, 38, 0.96), rgba(15, 17, 30, 0.92));
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      transition: transform 0.35s cubic-bezier(0.22, 1, 0.36, 1),
        border-color 0.35s ease,
        box-shadow 0.35s ease;
    }

    .story-card::before {
      content: '';
      position: absolute;
      inset: -60% -20% auto;
      height: 120%;
      background: radial-gradient(circle, rgba(255, 209, 102, 0.35), transparent 70%);
      opacity: 0;
      transform: translateY(20%);
      transition: opacity 0.4s ease, transform 0.4s ease;
      pointer-events: none;
    }

    .story-card::after {
      content: '';
      position: absolute;
      inset: auto -40% -60%;
      height: 160%;
      background: radial-gradient(circle at top, rgba(124, 208, 255, 0.25), transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }

    .story-card:hover,
    .story-card:focus-visible {
      transform: translateY(-8px);
      border-color: rgba(255, 209, 102, 0.45);
      box-shadow: 0 24px 45px -25px rgba(10, 20, 40, 0.9);
    }

    .story-card:hover::before,
    .story-card:focus-visible::before {
      opacity: 0.7;
      transform: translateY(0);
    }

    .story-card:hover::after,
    .story-card:focus-visible::after {
      opacity: 1;
    }

    .story-card h4 {
      margin: 0;
      font-size: 1.15rem;
      color: rgba(255, 209, 102, 0.95);
      letter-spacing: 0.01em;
      position: relative;
      z-index: 1;
    }

    .story-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(124, 208, 255, 0.9);
      background: rgba(20, 28, 50, 0.65);
      padding: 0.35rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(124, 208, 255, 0.2);
      position: relative;
      z-index: 1;
    }

    .story-metric {
      display: flex;
      align-items: baseline;
      gap: 0.6rem;
      position: relative;
      z-index: 1;
    }

    .story-metric__value {
      font-size: clamp(1.45rem, 2.6vw, 1.8rem);
      font-weight: 700;
      color: rgba(232, 236, 255, 0.98);
      font-family: 'DM Sans', sans-serif;
    }

    .story-metric__label {
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: rgba(148, 184, 255, 0.75);
    }

    .story-card p {
      color: rgba(203, 212, 248, 0.75);
      font-size: 0.94rem;
      margin: 0;
      position: relative;
      z-index: 1;
    }

    .story-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: auto;
      position: relative;
      z-index: 1;
    }

    .story-share {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 0.55rem 0.95rem;
      border-radius: 999px;
      border: 1px solid rgba(124, 208, 255, 0.24);
      background: rgba(28, 34, 60, 0.6);
      color: rgba(210, 220, 255, 0.9);
      font-size: 0.78rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.25s ease, border-color 0.25s ease, background 0.25s ease;
      text-decoration: none;
    }

    .story-share:hover,
    .story-share:focus-visible {
      transform: translateY(-2px);
      border-color: rgba(255, 209, 102, 0.55);
      background: rgba(38, 46, 70, 0.9);
      color: rgba(255, 209, 102, 0.95);
    }

    @media (max-width: 960px) {
      .insight-stack {
        grid-template-columns: 1fr;
      }

      main {
        padding-top: 3.5rem;
      }
    }

    @media (max-width: 720px) {
      .dashboard-hero {
        grid-template-columns: 1fr;
      }

      .summary-card {
        padding: 1.5rem;
      }

      .nav-container {
        gap: 1rem;
      }

      .mobile-menu-btn {
        display: inline-flex;
      }

      .nav-links {
        margin-left: 0;
        position: absolute;
        top: calc(100% + 12px);
        right: 24px;
        left: 24px;
        display: none;
        flex-direction: column;
        align-items: stretch;
        gap: 1rem;
        padding: 1.2rem;
        background: rgba(8, 10, 22, 0.95);
        border: 1px solid rgba(118, 144, 255, 0.18);
        border-radius: 16px;
        box-shadow: 0 24px 45px -30px rgba(8, 10, 20, 0.95);
        z-index: 150;
      }

      .nav-links.open {
        display: flex;
      }

      .nav-link {
        font-size: 1rem;
      }

      .nav-cta {
        width: 100%;
      }

      .toast {
        left: 16px;
        right: 16px;
        bottom: 16px;
        text-align: center;
      }
      .insight-badges {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }

      .insight-table th,
      .insight-table td {
        font-size: 0.88rem;
      }
    }
  </style>
  
</head>
<body>
  <nav class="navbar" id="navbar">
    <div class="nav-container">
      <a class="logo" href="/index.html">
        <span class="logo-chicago">Chicago'</span>
        <span class="logo-dollar">$</span>
        <span class="logo-money">Money</span>
      </a>
      <button
        class="mobile-menu-btn"
        type="button"
        aria-label="Toggle navigation"
        aria-controls="primaryNav"
        aria-expanded="false"
      >
        <span></span>
        <span></span>
        <span></span>
      </button>
      <div class="nav-links" id="primaryNav">
        <a href="/index.html" class="nav-link">Home</a>
        <a href="/salary-lookup.html" class="nav-link">Salary Lookup</a>
        <a href="/budget-dashboard.html" class="nav-link active" aria-current="page">Budget Dashboard</a>
        <a href="/index.html#leads" class="nav-link">Business Intelligence</a>
        <a href="/index.html#contact" class="nav-link">Contact</a>
        <a href="/index.html#leads" class="nav-cta">Get Leads â†’</a>
      </div>
    </div>
  </nav>

  <div class="toast" id="dashboardToast" role="status" aria-live="polite" aria-atomic="true" aria-hidden="true"></div>

  <main>
    <header style="margin-bottom: 2.5rem; max-width: 780px;">
      <div class="story-chip">CITY PAYROLL INTELLIGENCE</div>
      <h1 style="font-size: clamp(2.4rem, 4vw, 3.3rem); margin: 0 0 1rem; font-weight: 800;">
        Chicago's <span style="color: var(--accent-gold);">live</span> payroll, overtime, and staffing dashboard
      </h1>
      <p style="color: var(--text-secondary); font-size: 1.05rem; max-width: 720px;">
        Explore spending trends, overtime surges, and staffing shifts across every city department. Updated directly from the City of Chicago data portal.
      </p>
    </header>

    <section class="dashboard-hero" id="dashboardSummary">
      <article class="summary-card" data-summary="total-payroll">
        <div class="summary-label">Total payroll (YTD)</div>
        <div class="summary-value" id="totalPayroll">$0</div>
        <div class="summary-sub"><span class="summary-delta" id="totalPayrollDelta">â€”</span><span class="summary-note" id="totalPayrollNote">City payroll dataset snapshot</span></div>
      </article>
      <article class="summary-card" data-summary="overtime">
        <div class="summary-label">Overtime spend</div>
        <div class="summary-value" id="totalOvertime">$0</div>
        <div class="summary-sub"><span class="summary-delta" id="overtimeDelta">â€”</span><span class="summary-note" id="overtimeNote">City payroll dataset snapshot</span></div>
      </article>
      <article class="summary-card" data-summary="headcount">
        <div class="summary-label">Active headcount</div>
        <div class="summary-value" id="headcount">0</div>
        <div class="summary-sub"><span class="summary-delta" id="headcountDelta">â€”</span><span class="summary-note" id="headcountNote">City payroll dataset snapshot</span></div>
      </article>
    </section>
    <section class="canvas-panel">
      <div class="panel-header">
        <h2>Workforce snapshot</h2>
        <p class="panel-note">Fast highlights pulled from the latest payroll file â€” no charts, just the headline numbers that matter.</p>
      </div>
      <div class="highlight-grid" id="snapshotHighlights">
        <article class="highlight-card">
          <span class="label">Loading insightsâ€¦</span>
          <span class="value">â€”</span>
          <span class="meta">Fetching the latest metrics.</span>
        </article>
      </div>
    </section>

    <section class="insight-stack">
      <div class="insight-intro">
        <div class="panel-header">
          <h2>Department trends</h2>
          <p>Quick pulse of the busiest departments across payroll, overtime, and staffing right now.</p>
        </div>
        <div class="insight-badges" id="insightBadges">
          <!-- populated by JS -->
        </div>
        <div class="insight-table">
          <table>
            <thead>
              <tr><th>Department</th><th class="metric">Value</th></tr>
            </thead>
            <tbody id="insightTable"><tr><td>Loadingâ€¦</td><td></td></tr></tbody>
          </table>
        </div>
      </div>
      <aside class="insight-card compact">
        <h3>Top movers</h3>
        <ul class="insight-list" id="insightList">
          <li><span>Loading...</span><span></span></li>
        </ul>
      </aside>
    </section>

    <section>
      <div class="panel-header" style="margin-bottom: 1.25rem;">
        <h2>Stories worth sharing</h2>
        <div class="filters" id="storyFilters">
          <button class="filter-chip active" data-story="overtime">Overtime spike</button>
          <button class="filter-chip" data-story="newHires">Staffing leaders</button>
          <button class="filter-chip" data-story="payGap">Comp spotlight</button>
        </div>
      </div>
      <div class="story-mode" id="storyDeck"></div>
    </section>
  </main>

  <script>
    const navLinksContainer = document.getElementById('primaryNav');
    const mobileMenuButton = document.querySelector('.mobile-menu-btn');

    const closeMobileNav = () => {
      if (!navLinksContainer || !mobileMenuButton) return;
      navLinksContainer.classList.remove('open');
      mobileMenuButton.classList.remove('is-open');
      mobileMenuButton.setAttribute('aria-expanded', 'false');
    };

    const toggleMobileNav = () => {
      if (!navLinksContainer || !mobileMenuButton) return;
      const willOpen = !navLinksContainer.classList.contains('open');
      navLinksContainer.classList.toggle('open', willOpen);
      mobileMenuButton.classList.toggle('is-open', willOpen);
      mobileMenuButton.setAttribute('aria-expanded', String(willOpen));
    };

    const handleResize = () => {
      if (!navLinksContainer || !mobileMenuButton) return;
      if (window.innerWidth > 720) {
        navLinksContainer.classList.remove('open');
        mobileMenuButton.classList.remove('is-open');
        mobileMenuButton.setAttribute('aria-expanded', 'false');
      }
    };

    if (mobileMenuButton && navLinksContainer) {
      mobileMenuButton.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleMobileNav();
      });

      navLinksContainer.querySelectorAll('a').forEach((anchor) => {
        anchor.addEventListener('click', () => {
          if (window.innerWidth <= 720) {
            closeMobileNav();
          }
        });
      });
    }

    window.addEventListener('resize', handleResize);

    document.addEventListener('click', (event) => {
      if (!navLinksContainer || !mobileMenuButton) return;
      if (window.innerWidth > 720) return;
      if (navLinksContainer.contains(event.target)) return;
      if (mobileMenuButton.contains(event.target)) return;
      closeMobileNav();
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      closeMobileNav();
    });

    handleResize();

    const PROXY_BASE = '/api/salaries.php';
    const DATASET_JSON = 'https://data.cityofchicago.org/resource/xzkq-xp2w.json';
    const toastEl = document.getElementById('dashboardToast');
    let toastTimeout = null;

    const SUMMARY_FALLBACK = {
      payrollTotal: 4_200_000_000,
      overtime: 680_000_000,
      headcount: 32000
    };

    const BREAKDOWN_FALLBACK = {
      hourlyBreakdown: {
        salary: 25500,
        hourly: 6500
      },
      staffingSplit: {
        fullTime: 29500,
        partTime: 2500
      }
    };

    const DEPARTMENT_FALLBACK = {
      payroll: [
        { department: 'Chicago Police Department', metric: 1_580_000_000 },
        { department: 'Chicago Fire Department', metric: 720_000_000 },
        { department: 'Department of Water Management', metric: 380_000_000 },
        { department: 'Chicago Department of Transportation', metric: 265_000_000 },
        { department: 'Chicago Public Library', metric: 190_000_000 }
      ],
      overtime: [
        { department: 'Chicago Police Department', metric: 280_000_000 },
        { department: 'Chicago Fire Department', metric: 190_000_000 },
        { department: 'Department of Water Management', metric: 58_000_000 },
        { department: 'Chicago Department of Streets & Sanitation', metric: 42_000_000 },
        { department: 'Department of Aviation', metric: 36_000_000 }
      ],
      headcount: [
        { department: 'Chicago Police Department', metric: 13800 },
        { department: 'Chicago Public Schools (Citywide)', metric: 9800 },
        { department: 'Chicago Fire Department', metric: 5100 },
        { department: 'Chicago Department of Aviation', metric: 3000 },
        { department: 'Department of Water Management', metric: 2800 }
      ]
    };

    const cloneRows = (rows = []) => rows.map((row) => ({ ...row }));

    const applyBreakdownFallback = () => {
      chartState.hourlyBreakdown = { ...BREAKDOWN_FALLBACK.hourlyBreakdown };
      chartState.staffingSplit = { ...BREAKDOWN_FALLBACK.staffingSplit };
      renderHighlights();
      refreshSummaryDetails();
    };

    const chartState = {
      departmentMetric: 'payroll',
      cachedDepartment: {
        payroll: cloneRows(DEPARTMENT_FALLBACK.payroll),
        overtime: cloneRows(DEPARTMENT_FALLBACK.overtime),
        headcount: cloneRows(DEPARTMENT_FALLBACK.headcount)
      },
      departmentFetched: {
        payroll: false,
        overtime: false,
        headcount: false
      },
      rawSummary: { ...SUMMARY_FALLBACK },
      hourlyBreakdown: { ...BREAKDOWN_FALLBACK.hourlyBreakdown },
      staffingSplit: { ...BREAKDOWN_FALLBACK.staffingSplit }
    };

    const datasetUrl = (params = {}) => {
      const url = new URL(DATASET_JSON);
      Object.entries(params).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== '') {
          url.searchParams.set(key, value);
        }
      });
      return url.toString();
    };

    const settledRows = (result) => (result?.status === 'fulfilled' && Array.isArray(result.value)) ? result.value : [];

    const toNumber = (value) => Number(value || 0);

    const formatCurrencyCompact = (value) => {
      if (!value) return '$0';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', notation: 'compact', maximumFractionDigits: 1 }).format(value);
    };

    const formatCurrencyFull = (value) => {
      if (!value) return '$0';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(value);
    };

    const fetchThroughProxy = (buildUrl) => {
      const url = new URL(PROXY_BASE, window.location.origin);
      url.searchParams.set('url', buildUrl());
      return fetch(url).then((res) => {
        if (!res.ok) throw new Error(`Proxy HTTP ${res.status}`);
        return res.json();
      });
    };

    const renderSummary = (payroll, overtime, headcount) => {
      const payrollEl = document.getElementById('totalPayroll');
      const overtimeEl = document.getElementById('totalOvertime');
      const headcountEl = document.getElementById('headcount');
      if (!payrollEl || !overtimeEl || !headcountEl) return;
      payrollEl.textContent = formatCurrencyCompact(payroll);
      overtimeEl.textContent = formatCurrencyCompact(overtime);
      headcountEl.textContent = Number(headcount || 0).toLocaleString();
    };

    const setSummaryMetric = ({
      valueId,
      noteId,
      value,
      format = 'text',
      decimals = 1,
      unit = '',
      note,
      emphasize = false
    }) => {
      const valueEl = document.getElementById(valueId);
      if (valueEl) {
        valueEl.classList.remove('delta-positive', 'delta-negative');
        if (value === null || value === undefined || Number.isNaN(value)) {
          valueEl.textContent = 'â€”';
        } else {
          let formatted;
          switch (format) {
            case 'currency':
              formatted = formatCurrencyCompact(value);
              break;
            case 'currency-full':
              formatted = formatCurrencyFull(value);
              break;
            case 'percent':
              formatted = `${Number(value).toFixed(decimals)}%${unit}`;
              break;
            case 'count':
              formatted = `${Number(value).toLocaleString()}${unit ? ` ${unit}` : ''}`;
              break;
            default:
              formatted = value;
          }
          valueEl.textContent = formatted;
          if (emphasize && Number(value) > 0) valueEl.classList.add('delta-positive');
        }
      }
      if (noteId) {
        const noteEl = document.getElementById(noteId);
        if (noteEl) noteEl.textContent = note || '';
      }
    };

    const applySummaryFallback = () => {
      renderSummary(SUMMARY_FALLBACK.payrollTotal, SUMMARY_FALLBACK.overtime, SUMMARY_FALLBACK.headcount);
      chartState.rawSummary = { ...SUMMARY_FALLBACK };
      chartState.hourlyBreakdown = { ...BREAKDOWN_FALLBACK.hourlyBreakdown };
      chartState.staffingSplit = { ...BREAKDOWN_FALLBACK.staffingSplit };
      chartState.cachedDepartment = {
        payroll: cloneRows(DEPARTMENT_FALLBACK.payroll),
        overtime: cloneRows(DEPARTMENT_FALLBACK.overtime),
        headcount: cloneRows(DEPARTMENT_FALLBACK.headcount)
      };
      chartState.departmentFetched = { payroll: false, overtime: false, headcount: false };
      setSummaryMetric({
        valueId: 'totalPayrollDelta',
        noteId: 'totalPayrollNote',
        value: chartState.cachedDepartment.payroll[0]?.metric ?? null,
        format: 'currency',
        note: chartState.cachedDepartment.payroll[0]
          ? `Top department: ${chartState.cachedDepartment.payroll[0].department}`
          : 'City payroll dataset snapshot'
      });
      setSummaryMetric({
        valueId: 'overtimeDelta',
        noteId: 'overtimeNote',
        value: 100 * (SUMMARY_FALLBACK.overtime / SUMMARY_FALLBACK.payrollTotal),
        format: 'percent',
        decimals: 1,
        note: chartState.cachedDepartment.overtime[0]
          ? `Leading OT dept: ${chartState.cachedDepartment.overtime[0].department}`
          : 'City payroll dataset snapshot'
      });
      const fallbackFullShare = (chartState.staffingSplit.fullTime / (chartState.staffingSplit.fullTime + chartState.staffingSplit.partTime)) * 100;
      setSummaryMetric({
        valueId: 'headcountDelta',
        noteId: 'headcountNote',
        value: Number.isFinite(fallbackFullShare) ? fallbackFullShare : null,
        format: 'percent',
        decimals: 1,
        note: `${chartState.staffingSplit.fullTime.toLocaleString()} full-time â€¢ ${chartState.staffingSplit.partTime.toLocaleString()} part-time`
      });
      renderHighlights();
      refreshSummaryDetails();
    };

    async function loadSummary() {
      try {
        const summaryQuery = datasetUrl({
          '$select': [
            'sum(annual_salary) as total_payroll',
            "sum(case when upper(salary_or_hourly)='HOURLY' then hourly_rate*2080 else 0 end) as total_overtime",
            'count(1) as headcount'
          ].join(', ')
        });

        const [summaryRes] = await Promise.allSettled([
          fetchThroughProxy(() => summaryQuery)
        ]);

        const summaryRows = settledRows(summaryRes);
        const summaryRow = summaryRows?.[0] || {};

        const payrollTotal = toNumber(summaryRow.total_payroll) || SUMMARY_FALLBACK.payrollTotal;
        const overtime = toNumber(summaryRow.total_overtime) || SUMMARY_FALLBACK.overtime;
        const headcount = toNumber(summaryRow.headcount) || SUMMARY_FALLBACK.headcount;

        renderSummary(payrollTotal, overtime, headcount);
        chartState.rawSummary = { payrollTotal, headcount, overtime };
        chartState.hourlyBreakdown = { ...BREAKDOWN_FALLBACK.hourlyBreakdown };
        chartState.staffingSplit = { ...BREAKDOWN_FALLBACK.staffingSplit };

        renderHighlights();
        refreshSummaryDetails();
        await loadBreakdowns();
      } catch (error) {
        console.warn('Summary fetch failed, using fallback', error);
        applySummaryFallback();
      }
    }

    async function loadBreakdowns() {
      try {
        const [payTypeRes, staffingRes] = await Promise.allSettled([
          fetchThroughProxy(() => datasetUrl({
            '$select': "upper(salary_or_hourly) as pay_type, count(1) as total",
            '$group': 'pay_type',
            '$where': 'salary_or_hourly IS NOT NULL'
          })),
          fetchThroughProxy(() => datasetUrl({
            '$select': "upper(full_or_part_time) as status, count(1) as total",
            '$group': 'status',
            '$where': 'full_or_part_time IS NOT NULL'
          }))
        ]);

        const payTypeRows = settledRows(payTypeRes);
        if (payTypeRows.length) {
          chartState.hourlyBreakdown = payTypeRows.reduce((acc, row) => {
            const label = (row?.pay_type || '').toString().trim().toLowerCase();
            const total = toNumber(row?.total);
            if (label.startsWith('hour')) acc.hourly += total;
            else if (label.startsWith('sal')) acc.salary += total;
            return acc;
          }, { salary: 0, hourly: 0 });
        } else {
          chartState.hourlyBreakdown = { ...BREAKDOWN_FALLBACK.hourlyBreakdown };
        }

        const staffingRows = settledRows(staffingRes);
        if (staffingRows.length) {
          chartState.staffingSplit = staffingRows.reduce((acc, row) => {
            const label = (row?.status || '').toString().trim().toUpperCase();
            const total = toNumber(row?.total);
            if (label === 'F') acc.fullTime += total;
            else if (label === 'P') acc.partTime += total;
            return acc;
          }, { fullTime: 0, partTime: 0 });
        } else {
          chartState.staffingSplit = { ...BREAKDOWN_FALLBACK.staffingSplit };
        }

        renderHighlights();
        refreshSummaryDetails();
      } catch (error) {
        console.warn('Breakdown fetch failed', error);
        applyBreakdownFallback();
      }
    }

    function refreshSummaryDetails() {
      const summary = chartState.rawSummary || {};
      const payrollTop = (chartState.cachedDepartment.payroll || [])[0];
      if (payrollTop) {
        setSummaryMetric({
          valueId: 'totalPayrollDelta',
          noteId: 'totalPayrollNote',
          value: payrollTop.metric,
          format: 'currency',
          note: `Top department: ${payrollTop.department}`
        });
      } else {
        setSummaryMetric({
          valueId: 'totalPayrollDelta',
          noteId: 'totalPayrollNote',
          value: null,
          note: 'City payroll dataset snapshot'
        });
      }

      const payrollTotal = summary.payrollTotal;
      const overtimeTotal = summary.overtime;
      const overtimeTop = (chartState.cachedDepartment.overtime || [])[0];
      if (payrollTotal && overtimeTotal >= 0) {
        const share = payrollTotal ? (overtimeTotal / payrollTotal) * 100 : null;
        const validShare = Number.isFinite(share) ? share : null;
        setSummaryMetric({
          valueId: 'overtimeDelta',
          noteId: 'overtimeNote',
          value: validShare,
          format: 'percent',
          decimals: 1,
          note: overtimeTop ? `Leading OT dept: ${overtimeTop.department}` : 'Share of payroll from hourly roles'
        });
      } else {
        setSummaryMetric({
          valueId: 'overtimeDelta',
          noteId: 'overtimeNote',
          value: null,
          note: 'City payroll dataset snapshot'
        });
      }

      const split = chartState.staffingSplit || {};
      const totalStaff = (split.fullTime || 0) + (split.partTime || 0);
      if (totalStaff) {
        const fullShare = (split.fullTime / totalStaff) * 100;
        const headcountNote = `${split.fullTime.toLocaleString()} full-time â€¢ ${split.partTime.toLocaleString()} part-time`;
        setSummaryMetric({
          valueId: 'headcountDelta',
          noteId: 'headcountNote',
          value: fullShare,
          format: 'percent',
          decimals: 1,
          note: headcountNote
        });
      } else {
        setSummaryMetric({
          valueId: 'headcountDelta',
          noteId: 'headcountNote',
          value: null,
          note: 'City payroll dataset snapshot'
        });
      }
    }

    async function loadDepartment(metric = 'payroll') {
      if (chartState.departmentFetched[metric]) {
        return chartState.cachedDepartment[metric] || [];
      }

      const selectMap = {
        payroll: 'department, sum(annual_salary) as metric',
        overtime: "department, sum(case when upper(salary_or_hourly)='HOURLY' then hourly_rate*2080 else 0 end) as metric",
        headcount: 'department, count(1) as metric'
      };

      const deptUrl = () => datasetUrl({
        '$select': selectMap[metric],
        '$group': 'department',
        '$order': 'metric DESC',
        '$limit': '8',
        '$where': 'department IS NOT NULL'
      });

      try {
        const rows = await fetchThroughProxy(deptUrl);
        const cleaned = rows
          .map((row) => ({ department: row.department, metric: Number(row.metric || 0) }))
          .filter((row) => row.department && row.metric > 0);
        if (cleaned.length) {
          chartState.cachedDepartment[metric] = cleaned;
          chartState.departmentFetched[metric] = true;
          if (metric === 'payroll' || metric === 'overtime') refreshSummaryDetails();
          return cleaned;
        }
        const fallback = cloneRows(DEPARTMENT_FALLBACK[metric] || []);
        chartState.cachedDepartment[metric] = fallback;
        chartState.departmentFetched[metric] = false;
        if (metric === 'payroll' || metric === 'overtime') refreshSummaryDetails();
        return fallback;
      } catch (error) {
        console.warn('Department query failed, returning empty set', error);
        const fallback = cloneRows(DEPARTMENT_FALLBACK[metric] || []);
        chartState.cachedDepartment[metric] = fallback;
        chartState.departmentFetched[metric] = false;
        if (metric === 'payroll' || metric === 'overtime') refreshSummaryDetails();
        return fallback;
      }
    }

    function renderDepartment(data, metric) {
      renderBadges(data, metric);
      renderDepartmentTable(data, metric);
    }

    function renderBadges(data, metric) {
      const container = document.getElementById('insightBadges');
      if (!container) return;
      container.replaceChildren();
      if (!data.length) {
        const badge = document.createElement('div');
        badge.className = 'insight-badge';

        const emptyLabel = document.createElement('span');
        emptyLabel.textContent = 'No data';
        const dash = document.createElement('strong');
        dash.textContent = 'â€”';
        const hint = document.createElement('span');
        hint.textContent = 'Try another filter';

        badge.append(emptyLabel, dash, hint);
        container.appendChild(badge);
        return;
      }
      const label = metricLabel(metric);
      data.slice(0, 3).forEach((row, index) => {
        const badge = document.createElement('div');
        badge.className = 'insight-badge';

        const position = document.createElement('span');
        position.textContent = `${label} â€¢ #${index + 1}`;
        const department = document.createElement('strong');
        department.textContent = row.department || 'â€”';
        const metricSpan = document.createElement('span');
        const metricValue = metric === 'headcount'
          ? `${Number(row.metric || 0).toLocaleString()} employees`
          : formatCurrencyCompact(row.metric);
        metricSpan.textContent = metricValue;

        badge.append(position, department, metricSpan);
        container.appendChild(badge);
      });
    }

    function renderDepartmentTable(data, metric) {
      const table = document.getElementById('insightTable');
      if (!table) return;
      const header = document.querySelector('.insight-table th.metric');
      if (header) header.textContent = metricLabel(metric);
      table.replaceChildren();
      if (!data.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 2;
        td.textContent = 'No department data available.';
        tr.appendChild(td);
        table.appendChild(tr);
        return;
      }
      data.forEach((row) => {
        const tr = document.createElement('tr');
        const deptCell = document.createElement('td');
        deptCell.textContent = row.department || 'â€”';
        const metricCell = document.createElement('td');
        metricCell.className = 'metric';
        metricCell.textContent = metric === 'headcount'
          ? `${Number(row.metric || 0).toLocaleString()} staff`
          : formatCurrencyCompact(row.metric);
        tr.append(deptCell, metricCell);
        table.appendChild(tr);
      });
    }

    const metricLabel = (metric) => ({
      payroll: 'Payroll',
      overtime: 'Overtime',
      headcount: 'Headcount'
    }[metric] || 'Metric');

    function renderInsights(data, metric) {
      const insightList = document.getElementById('insightList');
      if (!insightList) return;

      insightList.replaceChildren();

      if (!data.length) {
        const item = document.createElement('li');
        const label = document.createElement('span');
        label.textContent = 'No recent movers';
        const value = document.createElement('span');
        value.textContent = '';
        item.append(label, value);
        insightList.appendChild(item);
        return;
      }

      const topEntries = data.slice(0, 5);
      const formatValue = (value) => (metric === 'headcount'
        ? `${Number(value || 0).toLocaleString()} staff`
        : formatCurrencyCompact(value));

      topEntries.forEach((row) => {
        const item = document.createElement('li');
        const dept = document.createElement('span');
        dept.textContent = row.department || 'â€”';
        const valueSpan = document.createElement('span');
        valueSpan.textContent = formatValue(row.metric);
        item.append(dept, valueSpan);
        insightList.appendChild(item);
      });
    }

    function renderHighlights({ topPayroll, topOvertime } = {}) {
      const container = document.getElementById('snapshotHighlights');
      if (!container) return;

      const summary = chartState.rawSummary || SUMMARY_FALLBACK;
      const headcount = summary.headcount || 0;
      const payroll = summary.payrollTotal || 0;
      const breakdown = chartState.hourlyBreakdown || { salary: 0, hourly: 0 };
      const totalPayTypes = (breakdown.salary || 0) + (breakdown.hourly || 0);

      const payrollLeader = topPayroll || (chartState.cachedDepartment.payroll || [])[0];
      const overtimeLeader = topOvertime || (chartState.cachedDepartment.overtime || [])[0];

      const items = [];
      const averageSalary = headcount ? payroll / headcount : null;
      items.push({
        label: 'Average salary',
        value: averageSalary ? formatCurrencyFull(averageSalary) : 'â€”',
        meta: headcount ? `${headcount.toLocaleString()} employees in the latest payroll.` : 'Using fallback employee counts.'
      });

      if (totalPayTypes) {
        const hourlyShare = (breakdown.hourly / totalPayTypes) * 100;
        items.push({
          label: 'Hourly workforce share',
          value: `${hourlyShare.toFixed(1)}% hourly`,
          meta: `${(breakdown.hourly || 0).toLocaleString()} hourly staff vs ${(breakdown.salary || 0).toLocaleString()} salaried.`
        });
      } else {
        items.push({
          label: 'Hourly workforce share',
          value: 'â€”',
          meta: 'Pay type breakdown unavailable; showing fallback data soon.'
        });
      }

      const payrollDept = payrollLeader?.department;
      const payrollValue = payrollLeader?.metric ? formatCurrencyCompact(payrollLeader.metric) : null;
      const overtimeDept = overtimeLeader?.department;
      const overtimeValue = overtimeLeader?.metric ? formatCurrencyCompact(overtimeLeader.metric) : null;

      const metaParts = [];
      if (payrollDept && payrollValue) metaParts.push(`${payrollValue} in base pay`);
      if (overtimeDept && overtimeValue) metaParts.push(`Overtime leader: ${overtimeDept} (${overtimeValue})`);

      items.push({
        label: 'Department spotlight',
        value: payrollDept || 'Department data pending',
        meta: metaParts.length ? metaParts.join(' â€¢ ') : 'Department rankings refresh once the data loads.'
      });

      container.replaceChildren();
      items.forEach((item) => {
        const card = document.createElement('article');
        card.className = 'highlight-card';

        const labelEl = document.createElement('span');
        labelEl.className = 'label';
        labelEl.textContent = item.label;

        const valueEl = document.createElement('span');
        valueEl.className = 'value';
        valueEl.textContent = item.value;

        const metaEl = document.createElement('span');
        metaEl.className = 'meta';
        metaEl.textContent = item.meta;

        card.append(labelEl, valueEl, metaEl);
        container.appendChild(card);
      });
    }

    function renderStories(data, metric) {
      const deck = document.getElementById('storyDeck');
      if (!deck) return;
      const top = data.slice(0, 3);
      const label = metricLabel(metric);
      deck.replaceChildren();
      if (!top.length) {
        const article = document.createElement('article');
        article.className = 'story-card';
        const chip = document.createElement('div');
        chip.className = 'story-chip';
        chip.textContent = 'No data';
        const message = document.createElement('p');
        message.textContent = 'All quiet for now. Try another view.';
        article.append(chip, message);
        deck.appendChild(article);
        return;
      }

      const formatStoryValue = (value) => (metric === 'headcount'
        ? `${Number(value || 0).toLocaleString()} staff`
        : formatCurrencyCompact(value));

      const metricSubtitle = metric === 'headcount' ? 'Headcount' : label;

      top.forEach((row, index) => {
        const article = document.createElement('article');
        article.className = 'story-card';
        article.tabIndex = 0;
        article.setAttribute('aria-label', `${label} spotlight for ${row.department || 'department'}`);
        article.dataset.department = encodeURIComponent(row.department || '');
        article.dataset.metric = metric;
        article.dataset.value = String(row.metric ?? '');

        const chip = document.createElement('div');
        chip.className = 'story-chip';
        chip.textContent = `Top ${index + 1}`;
        article.appendChild(chip);

        const heading = document.createElement('h4');
        heading.textContent = row.department || 'â€”';
        article.appendChild(heading);

        const metricWrap = document.createElement('div');
        metricWrap.className = 'story-metric';
        const metricValue = document.createElement('span');
        metricValue.className = 'story-metric__value';
        metricValue.textContent = formatStoryValue(row.metric);
        const metricLabelEl = document.createElement('span');
        metricLabelEl.className = 'story-metric__label';
        metricLabelEl.textContent = metricSubtitle;
        metricWrap.append(metricValue, metricLabelEl);
        article.appendChild(metricWrap);

        const paragraph = document.createElement('p');
        paragraph.append(`${label} is currently `);
        const strong = document.createElement('strong');
        strong.textContent = formatStoryValue(row.metric);
        paragraph.appendChild(strong);
        paragraph.append(', putting this department in the spotlight.');
        article.appendChild(paragraph);

        const actions = document.createElement('div');
        actions.className = 'story-actions';

        const linkShare = document.createElement('a');
        linkShare.className = 'story-share';
        linkShare.dataset.share = 'link';
        linkShare.href = '#';
        linkShare.dataset.department = encodeURIComponent(row.department || '');
        linkShare.dataset.metric = metric;
        linkShare.textContent = 'Share link';

        const imageShare = document.createElement('a');
        imageShare.className = 'story-share';
        imageShare.dataset.share = 'image';
        imageShare.href = '#';
        imageShare.dataset.department = encodeURIComponent(row.department || '');
        imageShare.dataset.metric = metric;
        imageShare.dataset.value = String(row.metric ?? '');
        imageShare.textContent = 'Share image';

        actions.append(linkShare, imageShare);
        article.appendChild(actions);

        deck.appendChild(article);
      });
      attachStoryShareHandlers();
    }

    const copyToClipboard = async (text) => {
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          showToast('Link copied to clipboard');
          return;
        }
        throw new Error('Clipboard API unavailable');
      } catch (err) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        showToast('Link copied to clipboard');
      }
    };

    const buildStoryUrl = (department, metric) => {
      const base = new URL(window.location.href);
      base.searchParams.set('view', 'story');
      if (department) base.searchParams.set('department', department);
      if (metric) base.searchParams.set('metric', metric);
      base.hash = '#storyDeck';
      return base.toString();
    };

    const buildOgImageUrl = (department, metric, value) => {
      const params = new URLSearchParams({ department, metric, value, timestamp: Date.now().toString() });
      return `/api/snapshot?${params.toString()}`;
    };

    function attachStoryShareHandlers() {
      document.querySelectorAll('.story-share').forEach((btn) => {
        btn.addEventListener('click', (event) => {
          event.preventDefault();
          const department = decodeURIComponent(btn.dataset.department || '');
          const metric = btn.dataset.metric || chartState.departmentMetric;
          if (btn.dataset.share === 'link') {
            copyToClipboard(buildStoryUrl(department, metric));
          } else {
            showToast('Generating share image...');
            const url = buildOgImageUrl(department, metric, btn.dataset.value || '');
            const preview = window.open(url, '_blank', 'noopener');
            if (!preview) window.location.href = url;
          }
        });
      });
    }

    function showToast(message) {
      if (!toastEl) return;
      toastEl.textContent = message;
      toastEl.setAttribute('aria-hidden', 'false');
      toastEl.classList.add('show');
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toastEl.classList.remove('show');
        toastEl.setAttribute('aria-hidden', 'true');
      }, 2200);
    }

    function attachFilterListeners() {
      const deptFilters = document.querySelectorAll('#deptFilters .filter-chip');
      if (deptFilters.length) {
        deptFilters.forEach((chip) => {
          chip.addEventListener('click', async () => {
            deptFilters.forEach((c) => c.classList.remove('active'));
            chip.classList.add('active');
            const metric = chip.dataset.view;
            chartState.departmentMetric = metric;
            const deptData = await loadDepartment(metric);
            renderDepartment(deptData, metric);
            renderStories(deptData, metric);
            renderInsights(deptData, metric);
            renderHighlights({
              topPayroll: (chartState.cachedDepartment.payroll || [])[0],
              topOvertime: (chartState.cachedDepartment.overtime || [])[0]
            });
          });
        });
      }

      document.querySelectorAll('#storyFilters .filter-chip').forEach((chip) => {
        chip.addEventListener('click', async () => {
          document.querySelectorAll('#storyFilters .filter-chip').forEach((c) => c.classList.remove('active'));
          chip.classList.add('active');
          const storyType = chip.dataset.story || 'paygap';
          const metricMap = { overtime: 'overtime', newhires: 'headcount', paygap: 'payroll' };
          const metric = metricMap[storyType.toLowerCase()] || 'payroll';
          const deptData = await loadDepartment(metric);
          chartState.departmentMetric = metric;
          renderDepartment(deptData, metric);
          renderStories(deptData, metric);
          renderInsights(deptData, metric);
          renderHighlights({
            topPayroll: (chartState.cachedDepartment.payroll || [])[0],
            topOvertime: (chartState.cachedDepartment.overtime || [])[0]
          });
        });
      });
    }

    async function bootstrapDashboard() {
      await loadSummary();

      const [payrollDepts, overtimeDepts] = await Promise.all([
        loadDepartment('payroll'),
        loadDepartment('overtime')
      ]);

      chartState.departmentMetric = 'payroll';
      renderDepartment(payrollDepts, 'payroll');
      renderStories(payrollDepts, 'payroll');
      renderInsights(payrollDepts, 'payroll');
      renderHighlights({ topPayroll: payrollDepts[0], topOvertime: overtimeDepts[0] });
    }

    document.addEventListener('DOMContentLoaded', () => {
      attachFilterListeners();
      bootstrapDashboard().catch((err) => console.error(err));
    });
  </script>
</body>
</html>
    
